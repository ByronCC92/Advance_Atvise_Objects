<?xml version="1.0" encoding="UTF-8"?>
<script>
  <metadata>
    <priority>0</priority>
    <owner>root</owner>
    <runcontext>caller</runcontext>
  </metadata>
  <parameter name="baseN" type="string" trigger="false" relative="false" value=""/>
  <parameter name="Root_PathI" type="string" trigger="false" relative="false" value=""/>
  <code><![CDATA[//External Variables
var Object_Conditions = Ua.findNode((baseN)+".Parameters.Object_Conditions");
var Initial_Values = Ua.findNode((baseN)+".Parameters.Initial_Values");
var Root_Path = Ua.findNode((baseN)+".Parameters.Root_Path");
var Global_Maintenance = Ua.findNode("AGENT.OBJECTS.Global_Maintenance");
console.log(baseN);
console.log("---------------Startup Script----------------");
//Global Variables
var Global_Conditions=alarming.conditions;
var Object_ConditionsI=new Array();
var Initial_ValuesI=new Array();
var Alert_Nodes=new Array();
var Ranges=new Array();
var Global_MaintenanceI=new Array();

//----------------Rootpath logic---------------//


//Asign to the node
Root_Path.result.assign({value: Root_PathI.substring(0, Root_PathI.lastIndexOf('.'))}); //Asign complete array

//----------------Conditions logic----------------//
for (var i=0; i<Global_Conditions.length; i++){
	
	var Config_conditions=alarming.configuration(Global_Conditions[i])[0];
	//Save the conditions that belong to the corresponding node
	if (Global_Conditions[i].includes(baseN.nodeid.split('=').pop())) {
		
		//Save initial state in global variable
		var Temp_variable = Ua.findNode(Config_conditions.input);		
		
	    if (Config_conditions.lowerLimit!=undefined){ //High Alarm
			Object_ConditionsI.push({Condition_name:Global_Conditions[i],Condition_node:Config_conditions.input,Condition_type:"Max",Condition_limit:Config_conditions.lowerLimit,Initial_value:Temp_variable.result.value});
		}
		else //Low Alarm
		{
			Object_ConditionsI.push({Condition_name:Global_Conditions[i],Condition_node:Config_conditions.input,Condition_type:"Min",Condition_limit:Config_conditions.upperLimit,Initial_value:Temp_variable.result.value});
		}
		
		//Keep a variable with the nodes separately
		if (isElementIncluded(Alert_Nodes,Config_conditions.input)!=true){ //It doesn´t exist anymore
			Alert_Nodes.push(Config_conditions.input);
			Ranges.push([]);
		}
		//Assign initial values for later comparison
		Initial_ValuesI.push(Temp_variable.result.value);
		Initial_Values.result.assign({value: Initial_ValuesI});		
    }		
}

//Extract pairs of limits for each node
for (var i=0; i<Alert_Nodes.length; i++){
	for (var j=0; j<Object_ConditionsI.length; j++){
		if (Alert_Nodes[i]==Object_ConditionsI[j].Condition_node){
			Ranges[i].push(Object_ConditionsI[j].Condition_limit);
		}
	}
	
	if (Ranges[i].length==1){ //Only one limit
			Ranges[i].push(0); //Add a zero so that I always have a partner
		}
}

//Calculate and enter the Ranges
for (var i=0; i<Alert_Nodes.length; i++){
	for (var j=0; j<Object_ConditionsI.length; j++){
		if (Alert_Nodes[i]==Object_ConditionsI[j].Condition_node){
			Object_ConditionsI[j].Range=Math.abs(Ranges[i][0]-Ranges[i][1]);
			Object_ConditionsI[j]=JSON.stringify(Object_ConditionsI[j]);
		}
	}
}


//Assign the value to the node
Object_Conditions.result.assign({value: Object_ConditionsI}); //Asign Complete array	


//----------------Global Maintenance logic----------------//
//Global_Maintenance exists			
if (!isFirstElementObjectTypes(baseN)){ //If it is not from the father object
	if (Global_Maintenance.result!=undefined){
		
		//Push address
		var Global_MaintenanceII=((baseN)).split('=').pop();
		Global_MaintenanceI=Global_Maintenance.result.value;
		
		//Check if it exist
		if (!(Global_MaintenanceI.includes(Global_MaintenanceII))){
			
			if (Global_Maintenance.result.value==[""]){
				Global_MaintenanceI[0]=(Global_MaintenanceII);
			}
			else{
				Global_MaintenanceI.push(Global_MaintenanceII);
			}
			Global_Maintenance.result.assign({value: Global_MaintenanceI}); //Asign Complete array	 
		}
		 
	}
	//Global_Maintenance doesn´t exists	
	else if(Global_Maintenance.result==undefined){	
		//Create node
		Global_MaintenanceI[0]=((baseN)).split('=').pop();
		var Global_MaintenanceN="AGENT.OBJECTS.Global_Maintenance";
		Ua.createNode(Global_MaintenanceN, {
			nodeClass: Ua.NodeClass.VARIABLE,
			parent: "AGENT.OBJECTS",
			typeDefinition: Ua.VariableType.baseNVARIABLETYPE,
			reference: Ua.Reference.HASCOMPONENT,
			dataType: Ua.DataType.STRING,
			valueRank: Ua.ValueRank.ONEDIMENSION,
			value: Global_MaintenanceI
		});
	}
}


//Complementary functions
function isElementIncluded(array, element) {
  for (let i = 0; i < array.length; i++) {
    if (array[i] === element) {
      return true; // Element found in the array
    }
  }
  return false; // Element not found in the array
}

//Check if it is from Object tipe
function isFirstElementObjectTypes(arr) {
  const firstElement = arr;
  const splitElement = firstElement.split('.');
  return splitElement[0] === 'ObjectTypes';
}]]></code>
</script>
