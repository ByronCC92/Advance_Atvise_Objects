<?xml version="1.0" encoding="UTF-8"?>
<script>
  <metadata>
    <priority>0</priority>
    <owner>root</owner>
    <runcontext>caller</runcontext>
  </metadata>
  <parameter name="Trigger" type="alarm" trigger="true" relative="true">
    <RelativePath>
      <Elements>
        <RelativePathElement>
          <TargetName>
            <NamespaceIndex>1</NamespaceIndex>
            <Name>Variables</Name>
          </TargetName>
        </RelativePathElement>
        <RelativePathElement>
          <TargetName>
            <NamespaceIndex>1</NamespaceIndex>
            <Name>*</Name>
          </TargetName>
        </RelativePathElement>
      </Elements>
    </RelativePath>
  </parameter>
  <code><![CDATA[//Externas
var Alarm_Active  = Ua.findNode((base)+".Alarm_Active");
console.log(Alarm_Active);
//Variables Globales
var alarmas_activas_globales=alarming.list;
var alarmas_activas=new Array();


//Leo todas las alarmas existentes
for (var i=0; i<alarmas_activas_globales.length; i++){
	var alarma_activa=alarmas_activas_globales[i];
	
	//Guardo las alarmas activas y que pertenecen al nodo correspondiente
	if (alarma_activa.base.includes(base.nodeid.split('=').pop()) && alarma_activa.ActiveStateId==true) {
		var Config_conditions=alarming.configuration(alarma_activa.address)[0];		
		if (Config_conditions.lowerLimit!=undefined){ //Alarma MÃ¡xima
			alarmas_activas.push(JSON.stringify({Alarma:alarma_activa.base.split('AGENT.OBJECTS.').pop()+"."+alarma_activa.ConditionName,Condition_type:"Max",Status:alarma_activa.ActiveStateId,value:alarma_activa.value,Timestamp:alarma_activa.timestamp,eventText:alarma_activa.eventtext.en}));
		}
		else //Alarma Minima
		{
			alarmas_activas.push(JSON.stringify({Alarma:alarma_activa.base.split('AGENT.OBJECTS.').pop()+"."+alarma_activa.ConditionName,Condition_type:"Min",Status:alarma_activa.ActiveStateId,value:alarma_activa.value,Timestamp:alarma_activa.timestamp,eventText:alarma_activa.eventtext.en}));
		}
		
    }	
}

console.log(alarmas_activas);

//Asigno el valor al nodo
Alarm_Active.result.assign({value: alarmas_activas}); //Asigno al array Completo]]></code>
</script>
