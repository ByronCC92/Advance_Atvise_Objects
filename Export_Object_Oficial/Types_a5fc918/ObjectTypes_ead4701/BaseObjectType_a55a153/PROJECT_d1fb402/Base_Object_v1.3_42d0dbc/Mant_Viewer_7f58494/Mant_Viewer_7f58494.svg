<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<svg height="650" version="1.2" width="520" xmlns="http://www.w3.org/2000/svg" xmlns:atv="http://webmi.atvise.com/2007/svgext" xmlns:xlink="http://www.w3.org/1999/xlink">
 <defs/>
 <metadata>
  <atv:parameter behavior="optional" defaultvalue="SYSTEM.GLOBALS.Color_Global_1" desc="Color" name="Color" substitute="$Color$" valuetype="global"/>
  <atv:gridconfig enabled="true" gridstyle="lines" height="20" width="20"/>
  <atv:snapconfig enabled="true" height="10" width="10"/>
 </metadata>
 <svg atv:refpx="260" atv:refpy="300" height="640" id="id_0" transform="matrix(0.8125,0,0,0.8125,0,0)" width="640" x="0" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.slickgrid.table" y="1.231">
  <atv:argument name="tableID" value="Mant_Table"/>
  <atv:argument name="globalBorderColor" value="SYSTEM.GLOBALS.Color_Global_1"/>
  <atv:argument name="globalFillColor" value="SYSTEM.GLOBALS.Color_Global_1"/>
  <atv:argument name="globalFontColor" value="SYSTEM.GLOBALS.atvFontColor2"/>
 </svg>
 <svg atv:refpx="75" atv:refpy="604.992" height="30" id="Mant_Terminado" transform="matrix(1.625,0,0,1.6667,0,0)" width="80" x="6.154" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.button" y="347.993">
  <atv:argument name="label" value="T{Finish}"/>
  <atv:argument name="fontSize" value="20"/>
  <atv:overwrite height="48.001" id="id_6" transform="matrix(0.6154,0,0,0.6,0,0)" width="128"/>
  <atv:overwrite id="button_label_2" transform="matrix(0.6154,0,0,0.6,0,0)" x="65" y="36.5"/>
  <atv:overwrite id="button_label_1" transform="matrix(0.6154,0,0,0.6,0,0)" x="65" y="21.5"/>
  <atv:overwrite id="button_label" transform="matrix(0.6154,0,0,0.6,0,0)" x="65" y="29.5"/>
  <atv:overwrite id="button_symbol_bottom" transform="matrix(0.3692,0,0,0.36,0,0)" x="98.167" y="42.959"/>
  <atv:overwrite id="button_symbol_top" transform="matrix(0.3692,0,0,0.36,0,0)" x="98.167" y="21.626"/>
  <atv:overwrite id="button_symbol" transform="matrix(0.6154,0,0,0.6,0,0)" x="55" y="15"/>
  <atv:overwrite height="46.001" id="button_stroke" transform="matrix(0.6154,0,0,0.6,0,0)" width="126"/>
  <atv:overwrite height="48.001" id="button_bg" transform="matrix(0.6154,0,0,0.6,0,0)" width="128"/>
  <atv:overwrite height="50.001" id="outer_frame" transform="matrix(0.6154,0,0,0.6,0,0)" width="130"/>
 </svg>
 <text atv:refpx="188" atv:refpy="609" fill="$Color$" font-family="Arial" font-size="20" id="id_info" x="174.5" y="613.5">Texto</text>
 <text atv:refpx="87.431" atv:refpy="559" fill="$Color$" font-family="Arial" font-size="20" id="id_1" x="4.5" y="563.5">Choose Finished Maintenance</text>
 <script atv:desc="" atv:name="" type="text/ecmascript"><![CDATA[//Defino Variables
var self;
var tableData = [];
var Ind_Mant=0; //La fila del Mantenimiento que quiero marcar como terminado
var Table_Id;
var data_lista=[];
var configNode="AGENT.OBJECTS.TimerConfig"; //Nodo Configuración
var Mant_Notification=webMI.query["base"]+".Mant_Notification";
var Mant_ActiveR=webMI.query["base"]+".Mant_Active";

/*******Condiciones Iniciales*******/
webMI.addOnload(function() {

	//Definición de texto Inicial
    webMI.gfx.setText("id_info", "Press to finish");
});

/*******Codigo de Tabla HTML********/
webMI.table.loadResources(function () {

	/* Create the configuration */
	var config = [];

	/* Configuration of the columns to be displayed */
	config["columns"] =
		[
			{   id: "Number", name: "Number", field: "Number", sortable: false, filter: false, visible: true},
			{   id: "ID Global", name: "ID Global", field: "ID Global", sortable: false, filter: false, visible: false},
			{	id: "Name", name: "Name", field: "Name", sortable: false, filter: false, visible: true},
			{   id: "Initial Date", name: "Initial Date", field: "Initial Date", sortable: false, filter: true},
		];

	/* Configuration of the runtime behavior */
	config["mode"] = "live";
	
	/* Configuration selection of data */
	config["onClickCallback"] = function(e, info){   
		var item = info.item;     
        Ind_Mant = info.rowIndex;
        Global_Id=item["ID Global"];
        Table_Id = item.id                  
    }

	/* Configuration of the data query */
	config["dataRequestFunction"] =
		function customDataRequest(continuation) {
			self = this;
			webMI.data.read(Mant_ActiveR, function(e){
			    var result=e.value;	 			    
			    for (var i=0; i<result.length; i++){
					const myArray = result[i].split(".");
					data_lista.push({
						"Number": i,
						"ID Global":myArray[0].slice(7),
						"Name":myArray[1].slice(7),
						"Initial Date":(new Date(Number(myArray[2].slice(9,-1))).toString()).slice(0,-33)	
					});		
						    
				}
				var data = {};
				data.result= data_lista;
				tableData.push(data);
				self.addData(data);
			});					
		};
		

	/* Registration of the configuration */
	webMI.table.register("Mant_Table", "config",  config);
	webMI.table.setReady("Mant_Table", "config");
});




//Selecciono mantenimiento como terminado
webMI.addEvent("Mant_Terminado", "click", function(e) {
	//Leo que mantenimientos hay activos
	webMI.data.read(Mant_ActiveR, function(j) {
	   var Mant_Active=j.value;
	   
	   //Remuevo de Mant_Active
	   Mant_Active.splice(Ind_Mant, 1);										
	   webMI.data.write(Mant_ActiveR, Mant_Active);//Ingreso nuevo mantenimiento activo 
	   
	   //Remuevo de la Tabla	  
	   self.removeData(Table_Id);   
	   
	   //Remuevo de Mantenimiento Global
		webMI.data.read(configNode, function(e) {
			//Extraigo el array que necesito
			var Config_Nueva=JSON.parse(e.value);			
			var config=Config_Nueva[0].config.configs;
			
			//Busco el id
			var index=-1;     
			for (var i=0; i<config.length; i++){  
				if(config[i]["row"]==Global_Id) { 
					index=i;
				}
			}		
			if (index>(-1)){ //Si se encuentra el indice
				//Remuevo el Mantenimiento de configNode
				Config_Nueva[0].config.configs.splice(index, 1);					
				
				//Escribe los datos en el nodo
				webMI.data.write(configNode, JSON.stringify(Config_Nueva));	
			}   
	   	});
	   
	   //Remuevo Icono de mantenimiento
	   if (Mant_Active.length===0){ //Si esta vacío quito indicador de Mant
			webMI.data.write(Mant_Notification, "{}");//Ingreso nuevo mantenimiento activo
			//Notificación de que se termino
			webMI.gfx.setFill("id_info", "#0bbea9");	
			webMI.gfx.setText("id_info", "No pending maintenance left");     
			setTimeout(function(){
				webMI.display.closeWindow();
			},750);				   
		} 
		
		else{
			//Notificación de que se termino
			webMI.gfx.setFill("id_info", "#0bbea9");	
			webMI.gfx.setText("id_info", "Finished Correctly");     
			setTimeout(function(){
				webMI.gfx.setFill("id_info", webMI.query["Color"]);
				webMI.gfx.setText("id_info", "Press to finish");
			},750);
		}			
	});
});
]]></script>
</svg>
