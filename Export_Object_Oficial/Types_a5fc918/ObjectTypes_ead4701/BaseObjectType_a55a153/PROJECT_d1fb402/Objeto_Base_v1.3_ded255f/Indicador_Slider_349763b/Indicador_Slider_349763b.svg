<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<svg height="106" version="1.2" width="544.5" xmlns="http://www.w3.org/2000/svg" xmlns:atv="http://webmi.atvise.com/2007/svgext" xmlns:xlink="http://www.w3.org/1999/xlink">
 <defs/>
 <metadata>
  <atv:parameter behavior="optional" defaultvalue="" desc="Label" name="Label" substitute="$LABEL$" valuetype="string"/>
  <atv:parameter behavior="optional" desc="Input" name="Input" valuetype="address"/>
  <atv:parameter behavior="optional" desc="Object Conditions Node" name="Object_Conditions" valuetype="address"/>
  <atv:parameter behavior="optional" desc="Rango de Alertas" name="Alert_Range" valuetype="address"/>
  <atv:parameter behavior="optional" defaultvalue="" desc="Unit" name="Unit" valuetype="string"/>
  <atv:parameter behavior="optional" defaultvalue="#108a8e" desc="Color" group="Appereance" name="Color" substitute="$COLOR$" valuetype="color"/>
  <atv:gridconfig enabled="true" gridstyle="lines" height="20" width="20"/>
  <atv:snapconfig enabled="true" height="2" width="2"/>
 </metadata>
 <g atv:refpx="155.564" atv:refpy="86.374" id="id_23" transform="matrix(1,0,0,1,-300.011,-0.9994)">
  <polygon atv:refpx="429" atv:refpy="-11.827" fill="#d9d900" id="id_9" points="436.011,102.612 455.976,69.999 475.138,102.612" stroke="#0000ff" stroke-width="0"/>
  <text atv:refpx="455.146" atv:refpy="94.629" fill="#000000" font-family="Arial" font-size="28" id="id_14" transform="matrix(0.6746,0,0.0061,0.6746,145.2789,25.0848)" x="452.905" y="107.589">1</text>
 </g>
 <rect atv:refpx="216.072" atv:refpy="408.806" fill="#8e8e8e" height="23.821" id="id_17" stroke="#ffffff" stroke-width="0" width="400" x="114.745" y="33.503"/>
 <text atv:refpx="-25.625" atv:refpy="404.904" fill="#000000" font-family="Arial" font-size="16" font-weight="bold" id="id_18" x="67" y="19.5">$LABEL$</text>
 <text atv:refpx="-132.213" atv:refpy="437.404" fill="$COLOR$" font-family="Arial" font-size="16" id="id_20" x="4.5" y="53.5">30ºC</text>
 <line atv:refpx="115.5" atv:refpy="52" id="id_0" stroke="#626262" stroke-width="1" x1="115" x2="115" y1="34" y2="70"/>
 <line atv:refpx="510.5" atv:refpy="52" id="id_1" stroke="#626262" stroke-width="1" x1="514" x2="514" y1="34" y2="70"/>
 <text atv:refpx="55.742" atv:refpy="480.904" fill="#000000" font-family="Arial" font-size="16" font-weight="bold" id="id_3" text-anchor="middle" x="115" y="95.5">MIN</text>
 <text atv:refpx="444.633" atv:refpy="482.904" fill="#000000" font-family="Arial" font-size="16" font-weight="bold" id="id_4" text-anchor="middle" x="514" y="97.5">MAX</text>
 <rect atv:refpx="116" atv:refpy="45" fill="$COLOR$" height="18" id="id_2" stroke="#ffffff" stroke-width="0" width="398" x="116" y="36"/>
 <g atv:refpx="455.575" atv:refpy="86.374" id="id_12" transform="matrix(1,0,0,1,0,-0.9996)">
  <polygon atv:refpx="429" atv:refpy="-11.827" fill="#d9d900" id="id_10" points="436.011,102.612 455.976,69.999 475.138,102.612" stroke="#0000ff" stroke-width="0"/>
  <text atv:refpx="455.146" atv:refpy="94.629" fill="#000000" font-family="Arial" font-size="28" id="id_11" transform="matrix(0.6746,0,0.0061,0.6746,145.2789,25.0848)" x="452.905" y="107.589">1</text>
 </g>
 <g atv:refpx="455.857" atv:refpy="86.374" id="id_13" transform="matrix(0.6746,0,0,0.6746,267.6516,93.1199)">
  <rect atv:refpx="275" atv:refpy="-14" fill="#a30002" height="48" id="id_7" rx="11.077" ry="11.077" stroke="#0000ff" stroke-width="0" width="50" x="254" y="-34"/>
  <text atv:refpx="278.5" atv:refpy="-6" fill="#000000" font-family="Arial" font-size="28" id="id_8" x="275" y="-1.5">1</text>
 </g>
 <g atv:refpx="154.857" atv:refpy="86.374" id="id_26" transform="matrix(0.6746,0,0,0.6746,-33.3484,93.1199)">
  <rect atv:refpx="275" atv:refpy="-14" fill="#a30002" height="48" id="id_27" rx="11.077" ry="11.077" stroke="#0000ff" stroke-width="0" width="50" x="254" y="-34"/>
  <text atv:refpx="278.5" atv:refpy="-6" fill="#000000" font-family="Arial" font-size="28" id="id_28" x="275" y="-1.5">1</text>
 </g>
 <script atv:desc="" atv:name="" type="text/ecmascript"><![CDATA[//Variables Externas
var Input= webMI.query["Input"];
var Alert_RangeR= webMI.query["Alert_Range"];
var Object_ConditionsR= webMI.query["Object_Conditions"];
var Color_Linea = webMI.query["Color_Linea"];
var Color_Banda = webMI.query["Color_Banda"];
var Display_PopUp= webMI.query["Display_PopUp"];

//Variables Internas
var min;	
var max;
var alarmHigh;
var alarmLow;
var alertHigh;
var alertLow;
var Condiciones=new Array();
var Rango_Alarmas;

webMI.addOnload(function(e) {

	// Leo variables Iniciales de las propias condiciones del objeto
	if(Object_ConditionsR!=undefined && Alert_RangeR!=undefined){
		webMI.data.read([Object_ConditionsR,Alert_RangeR], function(e) {
		   var Object_Conditions=e[0].value;
		   var Alert_Range=e[1].value;
		   if(Object_Conditions.length!=0){ //No esta vacio
				for (var i=0; i<Object_Conditions.length; i++){
					//Busca condiciones del nodo correspondiente
					var Object_ConditionsI=JSON.parse(Object_Conditions[i]);
					if (Object_ConditionsI.Condition_node.split('ns=1;s=').pop()==Input) { 
						Condiciones.push(Object_ConditionsI);
						if (Object_ConditionsI.Condition_type=="Max"){ //Alarma máxima
							alarmHigh=Object_ConditionsI.Condition_limit;
						}
						else if (Object_ConditionsI.Condition_type=="Min"){ //Alarma máxima
							alarmLow=Object_ConditionsI.Condition_limit;
						}
					}
				}
				Rango_Alarmas=Condiciones[0].Rango;//Obtengo el rango	
				
				//Calculo Alertas	
				alertHigh=alarmHigh-(Alert_Range*Rango_Alarmas/100);
				alertLow=alarmLow+(Alert_Range*Rango_Alarmas/100);
				
				//Calculo Alarmas	
				max=alarmHigh+(Alert_Range*Rango_Alarmas/100);
				min=alarmLow-(Alert_Range*Rango_Alarmas/100);
				if (min<0){
					min=0;
				}
				console.log("Max: "+max);		
				console.log("Min: "+min);		
				
				//Escribo Max y Min
				webMI.gfx.setText("id_4", max);
				webMI.gfx.setText("id_3", min);
			   }
		});
	}

	webMI.gfx.setVisible("id_12", false);
	webMI.gfx.setVisible("id_13", false);
	webMI.gfx.setVisible("id_23", false);
	webMI.gfx.setVisible("id_26", false);
	
	//Escribo Max y Min
	webMI.gfx.setText("id_4", max);

});





webMI.data.subscribe(webMI.query["Input"], function(e) {


	var value=e.value;

	
	
	///////Cambio de Texto
	
	webMI.gfx.setText("id_20", webMI.sprintf(("T{%.2f}"+webMI.query["Unit"]), value));
	
	///////Cambio de Barra
	
	
	webMI.gfx.setScaleX("id_2", webMI.translate((value <= min)? (min) : ((value >= max) ? (max) : (value)), min,max, 0, 1));
	
	///////Simbolo de alerta
	
	//Alerta Baja
	if (alarmLow <= value && value <= alertLow){
		webMI.gfx.setVisible("id_23", true);	
		webMI.gfx.setVisible("id_12", false);
		}	
	
	//Alerta Alta
	if (alertHigh <= value && value <= alarmHigh){
		webMI.gfx.setVisible("id_12", true);
		webMI.gfx.setVisible("id_23", false);
		}		
		
	//Dentro de Rango de Operación	
	if (alertLow < value && value < alertHigh){
		webMI.gfx.setVisible("id_12", false);	
		webMI.gfx.setVisible("id_23", false);	
		}
		

	///////Simbolo de alarma
	
	//Alarma Baja
	if (min <= value && value < alarmLow) {
		webMI.gfx.setVisible("id_26", true);
		webMI.gfx.setVisible("id_23", false);
		webMI.gfx.setVisible("id_12", false);
		webMI.gfx.setVisible("id_13", false);
		}
	
	//Alarma Alta
	if (alarmHigh < value && value < max) {
		webMI.gfx.setVisible("id_13", true); 		
		webMI.gfx.setVisible("id_23", false);
		webMI.gfx.setVisible("id_12", false);
		webMI.gfx.setVisible("id_26", false);
		}		
	
	//Dentro de Rango de Alarmas
	if (alarmLow < value && value < alarmHigh){
		webMI.gfx.setVisible("id_26", false);
		webMI.gfx.setVisible("id_13", false);
		}
		
	//Fuera de los Rangos Max o MIn
	
	//Después del Minimo
	if (min >= value) {
		webMI.gfx.setVisible("id_26", true); 
		webMI.gfx.setVisible("id_23", false);
		webMI.gfx.setVisible("id_12", false);
		webMI.gfx.setVisible("id_13", false);
		webMI.gfx.setFill("id_2", "#a30002");
		}
	
	//Después del Máximo
	if (value >= max) {
		webMI.gfx.setVisible("id_13", true); 
		webMI.gfx.setVisible("id_23", false);
		webMI.gfx.setVisible("id_12", false);
		webMI.gfx.setVisible("id_26", false);
		webMI.gfx.setFill("id_2", "#a30002");
		}
		
		
		//Dentro de Rango entre Máximo y Mínimo
	if (min < value && value < max){		
		webMI.gfx.setFill("id_2", webMI.query["Color"]);
		}
		
		
});











]]></script>
</svg>
