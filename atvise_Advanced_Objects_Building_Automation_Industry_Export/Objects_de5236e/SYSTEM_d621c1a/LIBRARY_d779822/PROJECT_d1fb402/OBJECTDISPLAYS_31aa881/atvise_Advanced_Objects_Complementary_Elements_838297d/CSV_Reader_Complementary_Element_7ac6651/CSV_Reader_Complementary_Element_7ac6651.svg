<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<svg height="890" version="1.2" width="1675" xmlns="http://www.w3.org/2000/svg" xmlns:atv="http://webmi.atvise.com/2007/svgext" xmlns:xlink="http://www.w3.org/1999/xlink">
 <defs/>
 <metadata>
  <atv:parameter behavior="optional" defaultvalue="" desc="File Name" group="File" name="File_Name" valuetype="string"/>
  <atv:parameter behavior="optional" defaultvalue="" desc="File Name Change Trigger " group="File" name="File_Name_Trigger" valuetype="string"/>
  <atv:parameter behavior="optional" defaultvalue="1000" desc="maxRows" group="File" name="maxRows" valuetype="number"/>
  <atv:parameter behavior="optional" defaultvalue="" desc="TimeColumnName" group="Time" name="TimeColumnName" valuetype="string"/>
  <atv:parameter behavior="optional" defaultvalue="DD/MM/YYYY HH:mm" desc="DateFormat" group="Time" name="DateFormat" valuetype="string"/>
  <atv:parameter behavior="optional" defaultvalue="10000" desc="Update Time (S)" group="Time" name="Update_Time" valuetype="number"/>
  <atv:parameter behavior="optional" defaultvalue="SYSTEM.GLOBALS.Color_Global_1" desc="Color" group="Appereance" name="Color" substitute="$Color$" valuetype="global"/>
  <atv:parameter behavior="optional" defaultvalue="16" desc="Font_Size" group="Appereance" name="Font_Size" substitute="$Font_Size$" valuetype="number"/>
  <atv:gridconfig enabled="true" gridstyle="lines" height="20" width="20"/>
  <atv:snapconfig enabled="true" height="5" width="5"/>
 </metadata>
 <svg atv:refpx="837.46" atv:refpy="535.911" height="230" id="id_4" transform="matrix(2.2635,0,0,3,0,0)" width="740" x="0" xlink:href="SYSTEM.LIBRARY.PROJECT.OBJECTDISPLAYS.atvise_Advanced_Objects_Complementary_Elements.Alarm_Table_Complementary_Element" y="66.667">
  <atv:argument name="tableID" value="CSVReader"/>
  <atv:argument name="globalBorderColor" prefix="Color" value="SYSTEM.GLOBALS."/>
  <atv:argument name="globalFillColor" prefix="Color" value="SYSTEM.GLOBALS."/>
  <atv:argument name="globalFontColor" value="SYSTEM.GLOBALS.atvFontColor2"/>
  <atv:argument name="row_text_size" prefix="Font_Size" value=""/>
  <atv:argument name="detail_text_size" prefix="Font_Size" value=""/>
  <atv:argument name="footer_text_size" prefix="Font_Size" value=""/>
  <atv:argument name="row_height" value="25"/>
  <atv:argument name="filterBar" value="false"/>
 </svg>
 <line atv:refpx="842.5" atv:refpy="160" id="id_3" stroke="$Color$" stroke-width="2" x1="5" x2="1680" y1="160" y2="160"/>
 <g atv:refpx="492.505" atv:refpy="108.96" id="Date_Selection" transform="matrix(1,0,0,1,-60,55)">
  <svg atv:refpx="392.478" atv:refpy="70.416" height="30" id="id_2" transform="matrix(1.7188,0,0,1.1667,0,0)" width="160" x="157.088" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.picker_date" y="49.644">
   <atv:argument name="fontSize" value="20"/>
   <atv:argument name="name" value="CSV_Initial_Date"/>
   <atv:overwrite id="button_stroke" transform="matrix(0.5818,0,0,0.8571,0,0)" x="250.508" y="7.501"/>
   <atv:overwrite id="id_1" transform="matrix(0.5236,0,0,0.7714,0,0)" x="279.454" y="9.445"/>
   <atv:overwrite id="button_bg" transform="matrix(0.5818,0,0,0.8571,0,0)" x="250.508" y="7.501"/>
   <atv:overwrite id="datepicker_label" transform="matrix(0.5818,0,0,0.8571,0,0)" x="240.508" y="22.751"/>
   <atv:overwrite height="31.001" id="focus_frame" transform="matrix(0.5818,0,0,0.8571,0,0)" width="271.008"/>
   <atv:overwrite height="27.001" id="blinking_frame" transform="matrix(0.5818,0,0,0.8571,0,0)" width="243.008"/>
   <atv:overwrite height="27.001" id="input_bg" transform="matrix(0.5818,0,0,0.8571,0,0)" width="243.008"/>
   <atv:overwrite height="33.001" id="id_0" transform="matrix(0.5818,0,0,0.8571,0,0)" width="273.008"/>
   <atv:overwrite height="35.001" id="id_2" transform="matrix(0.5818,0,0,0.8571,0,0)" width="275.008"/>
  </svg>
  <text atv:refpx="300.733" atv:refpy="36" fill="$Color$" font-family="Arial" font-size="24" id="id_0" x="274.5" y="40.5">Intial Date</text>
  <svg atv:refpx="682.479" atv:refpy="65.416" height="30" id="id_15" transform="matrix(1.7188,0,0,1.1667,0,0)" width="160" x="325.81" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.picker_date" y="49.644">
   <atv:argument name="fontSize" value="20"/>
   <atv:argument name="name" value="CSV_Final_Date"/>
   <atv:overwrite id="button_stroke" transform="matrix(0.5818,0,0,0.8571,0,0)" x="250.508" y="7.501"/>
   <atv:overwrite id="id_1" transform="matrix(0.5236,0,0,0.7714,0,0)" x="279.454" y="9.445"/>
   <atv:overwrite id="button_bg" transform="matrix(0.5818,0,0,0.8571,0,0)" x="250.508" y="7.501"/>
   <atv:overwrite id="datepicker_label" transform="matrix(0.5818,0,0,0.8571,0,0)" x="240.508" y="22.751"/>
   <atv:overwrite height="31.001" id="focus_frame" transform="matrix(0.5818,0,0,0.8571,0,0)" width="271.008"/>
   <atv:overwrite height="27.001" id="blinking_frame" transform="matrix(0.5818,0,0,0.8571,0,0)" width="243.008"/>
   <atv:overwrite height="27.001" id="input_bg" transform="matrix(0.5818,0,0,0.8571,0,0)" width="243.008"/>
   <atv:overwrite height="33.001" id="id_0" transform="matrix(0.5818,0,0,0.8571,0,0)" width="273.008"/>
   <atv:overwrite height="35.001" id="id_2" transform="matrix(0.5818,0,0,0.8571,0,0)" width="275.008"/>
  </svg>
  <text atv:refpx="590.763" atv:refpy="36" fill="$Color$" font-family="Arial" font-size="24" id="id_16" x="564.5" y="40.5">Final Date</text>
 </g>
 <rect atv:refpx="60" atv:refpy="110" fill="#000000" height="40" id="background_play" stroke="none" stroke-width="2" width="40" x="40" y="90"/>
 <rect atv:refpx="110" atv:refpy="110" fill="#000000" height="40" id="background_history" stroke="none" stroke-width="2" width="40" x="90" y="90"/>
 <svg atv:refpx="110" atv:refpy="110" height="20" id="id_7" transform="matrix(2,0,0,2,0,0)" width="20" x="45" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Symbols.history" y="45">
  <atv:argument name="symbolColor" value="#ffffff"/>
 </svg>
 <svg atv:refpx="60" atv:refpy="110" height="20" id="id_8" transform="matrix(2,0,0,2,0,0)" width="20" x="20" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Symbols.20x20.play" y="45">
  <atv:argument name="symbolColor" value="#ffffff"/>
 </svg>
 <rect atv:refpx="60" atv:refpy="110" fill="#000000" fill-opacity="0" height="40" id="click_area_play" stroke="none" stroke-width="2" width="40" x="40" y="90"/>
 <rect atv:refpx="110" atv:refpy="110" fill="#000000" fill-opacity="0" height="40" id="click_area_history" stroke="none" stroke-width="2" width="40" x="90" y="90"/>
 <text atv:refpx="118" atv:refpy="39" fill="$Color$" font-family="Arial" font-size="34" id="id_9" x="25" y="51.5">CSV Reader</text>
 <svg atv:refpx="1252.5" atv:refpy="115" height="40" id="id_5" transform="matrix(1.9125,0,0,1.5,0,0)" width="400" x="454.902" xlink:href="SYSTEM.LIBRARY.PROJECT.OBJECTDISPLAYS.atvise_Advanced_Objects_Complementary_Elements.Text_Area_Complementary_Element" y="56.667">
  <atv:argument name="Name" value="CSV_Reader"/>
  <atv:argument name="Alignment" value="left"/>
  <atv:argument name="Border_Thickness" value="0"/>
  <atv:argument name="Font_Color" value="$Color$"/>
 </svg>
 <script atv:desc="" atv:name="" type="text/ecmascript"><![CDATA[//---------------Initialize Variables---------//

//Internal

//Table Variables
var self;
var Global_Data;
var tableData = [];
var Table_Data=[];
var Ready_Data=[];
var item; //Variable for current maintenance info
var Table_Id;
var Final_Date;
var Initial_Date;

//Index
var Table_Initialized=false;
var tableController;
var Action="Add";
var New_Values;
var New_Value;
var Keys=["ID"]; 
var Columns_ConfigI=[{   id: "ID", name: "ID", field: "ID", sortable: false, filter: false, visible: true, width:10}];

//Menu
var Backgrounds=["background_play","background_history"];
var Click_Area=["click_area_play","click_area_history"];
var Real_Time=true; //Comienza en tiempo real

//External
var File_Name=(webMI.query["File_Name"]).replace(/\\/g, '\\\\');;
var maxRows=webMI.query["maxRows"];
var DateFormat=webMI.query["DateFormat"];
var TimeColumnName=webMI.query["TimeColumnName"];
var Update_Time=webMI.query["Update_Time"];
var File_Name_Trigger=webMI.query["File_Name_Trigger"];
var Color=webMI.query["Color"];

//Confirmation Window Variables
var Action_Trigger_Name="Change_Global_Maintenance";
var Confirmation_Text;

//---------------Initial Conditions---------//

webMI.addOnload(function() {

	 //Start with Hidden Date Selection
    webMI.gfx.setFill(Backgrounds[0], Color);
    webMI.gfx.setVisible("Date_Selection", false);
    
    //Write value to the element remotely
	webMI.trigger.fire("write_value_CSV_Reader", {value:String("Reading: "+webMI.query["File_Name"])}); 
    
	//Prepare data
	PrepareData(function (e){     
	 (async () => {
		 await waitForCondition();		
				webMI.trigger.fire("update_mant_table", 0); //Update table				
		})();
	});


});



//---------------Trigger Section--------------//

//Monitor File_Name_Trigger for external object displays
webMI.trigger.connect("Update File Name"+File_Name_Trigger, function (e) {

	File_Name=e;
	
});


//Monitor Initial Date  
webMI.trigger.connect("com.atvise.datepicker_CSV_Initial_Date", function (e) {
	Initial_Date=new Date(e.value);
	if(Table_Initialized &&  Real_Time==false){
		webMI.trigger.fire("update_mant_table", 0); //Update chart
	}
});


//Monitor Final Date
webMI.trigger.connect("com.atvise.datepicker_CSV_Final_Date", function (e) {
	setTimeout(function() {
		Final_Date=new Date(e.value);	
		if(Table_Initialized &&  Real_Time==false){
			webMI.trigger.fire("update_mant_table", 0); //Update chart
		}
	},200);
});


//Real Time
webMI.addEvent(Click_Area[0], "click", function(e) {

	webMI.gfx.setFill(Backgrounds[0], Color);
	webMI.gfx.setFill(Backgrounds[1], "#000000");
    webMI.gfx.setVisible("Date_Selection", false);
    Real_Time=true;
    
  
	//Update Table
    if(Table_Initialized){
		//Prepare data
		PrepareData(function (e){		 
			webMI.trigger.fire("update_mant_table", 0); //Update table
		});
	}
});

//Histotical Data
webMI.addEvent(Click_Area[1], "click", function(e) {

	webMI.gfx.setFill(Backgrounds[1], Color);
	webMI.gfx.setFill(Backgrounds[0], "#000000");
    webMI.gfx.setVisible("Date_Selection", true);
    Real_Time=false;
      
    //Update Table
    if(Table_Initialized){
		//Prepare data
		PrepareData(function (e){		 
			webMI.trigger.fire("update_mant_table", 0); //Update table
		});
	}
});


//Monitor change agreement
webMI.trigger.connect(Action_Trigger_Name, function(e) {
	var text=e.value;	
	
	//Excecute action
	//modifyElement(Global_List_Address,Action,Modify_Index,New_Values);
});

//Update when it is in real time
setInterval(function(){
	if(Table_Initialized && Real_Time==true){
		//Prepare data
		PrepareData(function (e){		 
			webMI.trigger.fire("update_mant_table", 0); //Update table
		});
	}
},Update_Time);



//---------------Table Section--------------//
(async () => {
	await waitForCondition2();
	webMI.table.loadResources(function () {
	
		// Create the configuration //
		var config = [];
	
		// Configuration of the columns to be displayed //		
		config["columns"] = Columns_ConfigI;					
		
		
		// Configuration of the runtime behavior //
		config["mode"] = "live";
		
		
		
		// Configuration of the data query //
		config["dataRequestFunction"] =
			function customDataRequest(continuation) {
				self = this;
				tableController = webMI.table.request("CSVReader", "controller");
				console.log("Columns_ConfigI");
				console.log(Columns_ConfigI);
				webMI.trigger.connect("update_mant_table", function (h) {
				
					Table_Initialized=true;
					
					//------------Bring data from historian-----------//			
					
					//Filter Config
					Table_Data=[];
					Ready_Data=[];
					
					var TimeII;
					var TimeFI;
					
					//Extract Data from Global_Data				
					for (const i in Global_Data) {
						if (Global_Data.hasOwnProperty(i)) {
							TimeII=(new Date(parseDateString(Global_Data[i][TimeColumnName],DateFormat))).getTime();
							if(TimeII>=Initial_Date && TimeII<=Final_Date){ //It is between the time frame
								Table_Data.push(Global_Data[i]);
							}
						}
					}				
					//Prepare Ready data									
					for (var i=0; i<Table_Data.length; i++){
						var ObjectI={}
						for (var j=0; j<Keys.length; j++){	
							if (Keys[j]=="ID"){
								ObjectI[String(Keys[j])]=i;
							}
							else{
								ObjectI[Keys[j]]=Global_Data[i][Keys[j]]; 
							}
						}
	
						Ready_Data.push(ObjectI);				
					}					
					var data = {};
					data.result= Ready_Data;
					tableData.push(data);
					tableController.clearData(); //Clear Data
					self.addData(data);				
				});					
			};
			
	
		// Registration of the configuration //
		webMI.table.register("CSVReader", "config",  config);
		webMI.table.setReady("CSVReader", "config");
	});
})(); 



//---------------Functions Section--------------//


//Prepare data and time

function PrepareData(callback) {
	//Call Modification Script
    webMI.data.call("CVS_Reader_webMI_Method_Script", {"File_Name":File_Name , "Rows": maxRows}, function(e) {

		Global_Data=JSON.parse(e.result);
		console.log(Global_Data);
	
		//Date Picker shows current time
		Initial_Date=new Date(parseDateString(Global_Data[1][TimeColumnName],DateFormat));
		Final_Date=new Date(parseDateString(Global_Data[Global_Data.length-1][TimeColumnName],DateFormat));
		webMI.trigger.fire("com.atvise.datepicker_CSV_Initial_Date", Initial_Date.getTime()); 
		webMI.trigger.fire("com.atvise.datepicker_CSV_Final_Date", Final_Date.getTime()); 
		
		//Prepare Global_Data	
		for (const key in Global_Data[0]) {
			Keys.push(key);
			Columns_ConfigI.push({id: String(key) , name: String(key), field: String(key), sortable: false, filter: false, visible: true, width:200})
		}
		
		callback(); 
	});
}


//Wait for data to be ready
function waitForCondition() {
  return new Promise((resolve) => {
    const interval = setInterval(() => {
	var condition=(Initial_Date!=undefined&&tableController!=undefined&& Columns_ConfigI.length>1);
      if (condition) {
        clearInterval(interval);
        resolve(true);
      }
    }, 100);
  });
}
function waitForCondition2() {
  return new Promise((resolve) => {
    const interval = setInterval(() => {
	var condition=(Initial_Date!=undefined&&Global_Data!=undefined&& Columns_ConfigI.length>1);
      if (condition) {
        clearInterval(interval);
        resolve(true);
      }
    }, 100);
  });
}

//Parse based on date format
function parseDateString(dateStr, formatStr) {
    // Default date and time values
    var day = '01', month = '01', year = '1970';
    var hour = '00', minute = '00', second = '00', millisecond = '00';

    // Extracting date and time components based on the format string
    formatStr.split(/[\s\/:]+/).forEach((formatPart, index) => {
        var value = dateStr.split(/[\s\/:]+/)[index] || '00';
        if (formatPart === 'DD') day = value;
        if (formatPart === 'MM') month = value;
        if (formatPart === 'YYYY') year = value;
        if (formatPart === 'HH') hour = value;
        if (formatPart === 'mm') minute = value;
        if (formatPart === 's') second = value;
        if (formatPart === 'ms') millisecond = value;
    });

    // Convert to MM/DD/YYYY HH:mm:ss:ms format
    var newDateStr = `${month}/${day}/${year} ${hour}:${minute}:${second}.${millisecond}`;
    return new Date(newDateStr);
}






]]></script>
</svg>
