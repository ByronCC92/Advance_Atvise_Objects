<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<svg height="527" version="1.2" width="1000.04" xmlns="http://www.w3.org/2000/svg" xmlns:atv="http://webmi.atvise.com/2007/svgext" xmlns:xlink="http://www.w3.org/1999/xlink">
 <defs/>
 <metadata>
  <atv:parameter behavior="optional" defaultvalue="" desc="Global_List" name="Global_List" valuetype="global"/>
  <atv:parameter behavior="optional" defaultvalue="" desc="Global_List_Address" name="Global_List_Address" valuetype="string"/>
  <atv:parameter behavior="optional" defaultvalue="" desc="Global Trigger" name="Global_Trigger" valuetype="string"/>
  <atv:parameter behavior="optional" desc="Maintenance Elements Node" name="Mant_Elements" valuetype="address"/>
  <atv:parameter behavior="optional" config="List;Trigger" defaultvalue="Trigger" desc="Selection Method" name="Global_List_Method" valuetype="enum"/>
  <atv:parameter behavior="optional" defaultvalue="" desc="Color" name="Color" substitute="$Color$" valuetype="global"/>
  <atv:parameter behavior="optional" defaultvalue="16" desc="Font_Size" name="Font_Size" substitute="$Font_Size$" valuetype="number"/>
  <atv:gridconfig enabled="true" gridstyle="lines" height="20" width="20"/>
  <atv:snapconfig enabled="true" height="5" width="5"/>
 </metadata>
 <svg atv:refpx="175" atv:refpy="35.003" height="30" id="id_1" transform="matrix(1,0,0,1.3333,0,0)" width="160" x="95" xlink:href="SYSTEM.LIBRARY.PROJECT.OBJECTDISPLAYS.atvise_Advanced_Objects_Complementary_Elements.Combobox_Complementary_Element" y="11.251">
  <atv:argument name="name" value="Maintenance_Modifier"/>
  <atv:argument name="text1" value="T{Add}"/>
  <atv:argument name="text1value" value="0"/>
  <atv:argument name="text2" value="T{Modify}"/>
  <atv:argument name="text2value" value="1"/>
  <atv:argument name="text3" value="T{Remove}"/>
  <atv:argument name="text3value" value="2"/>
  <atv:argument name="fontSize" value="18"/>
  <atv:argument name="text4" value=""/>
  <atv:argument name="text5" value=""/>
  <atv:argument name="fontFamily" value="MS Trebuchet,ITC Avant Garde Gothic,MS Arial,MS Verdana,Univers,Futura,ITC Stone Sans,Gill Sans,Akzidenz Grotesk,Helvetica,sans-serif"/>
  <atv:overwrite height="35.999" id="focus_frame" transform="matrix(1,0,0,0.75,0,0)"/>
  <atv:overwrite id="button_stroke" transform="matrix(1,0,0,0.75,0,0)" y="9.999"/>
  <atv:overwrite id="id_7" transform="matrix(1,0,0,0.75,0,0)" y="10.999"/>
  <atv:overwrite id="button_bg" transform="matrix(1,0,0,0.75,0,0)" y="9.999"/>
  <atv:overwrite id="combobox_label" transform="matrix(1,0,0,0.75,0,0)" y="24.499"/>
  <atv:overwrite height="31.999" id="blinking_frame" transform="matrix(1,0,0,0.75,0,0)"/>
  <atv:overwrite height="31.999" id="combobox_bg" transform="matrix(1,0,0,0.75,0,0)"/>
  <atv:overwrite height="37.999" id="id_1" transform="matrix(1,0,0,0.75,0,0)"/>
  <atv:overwrite height="39.999" id="id_0" transform="matrix(1,0,0,0.75,0,0)"/>
 </svg>
 <text atv:refpx="19.606" atv:refpy="36" fill="$Color$" font-family="Arial" font-size="24" id="id_2" x="5" y="40.5">Action</text>
 <svg atv:refpx="499.994" atv:refpy="333.003" height="230" id="id_4" transform="matrix(1.3514,0,0,1.2435,0,0)" width="740" x="0" xlink:href="SYSTEM.LIBRARY.PROJECT.OBJECTDISPLAYS.atvise_Advanced_Objects_Complementary_Elements.Alarm_Table_Complementary_Element" y="152.797">
  <atv:argument name="tableID" value="Mant_Global_List_Mod"/>
  <atv:argument name="globalBorderColor" prefix="Color" value="SYSTEM.GLOBALS."/>
  <atv:argument name="globalFillColor" prefix="Color" value="SYSTEM.GLOBALS."/>
  <atv:argument name="globalFontColor" value="SYSTEM.GLOBALS.atvFontColor2"/>
  <atv:argument name="row_text_size" prefix="Font_Size" value=""/>
  <atv:argument name="detail_text_size" prefix="Font_Size" value=""/>
  <atv:argument name="footer_text_size" prefix="Font_Size" value=""/>
  <atv:argument name="row_height" value="25"/>
 </svg>
 <svg atv:refpx="369.999" atv:refpy="31.001" height="30" id="Excecute" transform="matrix(2.375,0,0,1.3333,0,0)" width="80" x="117.895" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.button" y="11.25">
  <atv:argument name="label" value="T{Excecute}"/>
  <atv:argument name="fontSize" value="20"/>
  <atv:overwrite height="37.999" id="id_6" transform="matrix(0.4211,0,0,0.75,0,0)" width="188"/>
  <atv:overwrite id="button_label_2" transform="matrix(0.4211,0,0,0.75,0,0)" x="95" y="31.499"/>
  <atv:overwrite id="button_label_1" transform="matrix(0.4211,0,0,0.75,0,0)" x="95" y="16.499"/>
  <atv:overwrite id="button_label" transform="matrix(0.4211,0,0,0.75,0,0)" x="95" y="24.499"/>
  <atv:overwrite id="button_symbol_bottom" transform="matrix(0.2526,0,0,0.45,0,0)" x="148.167" y="34.624"/>
  <atv:overwrite id="button_symbol_top" transform="matrix(0.2526,0,0,0.45,0,0)" x="148.167" y="13.291"/>
  <atv:overwrite id="button_symbol" transform="matrix(0.4211,0,0,0.75,0,0)" x="85" y="9.999"/>
  <atv:overwrite height="35.999" id="button_stroke" transform="matrix(0.4211,0,0,0.75,0,0)" width="186"/>
  <atv:overwrite height="37.999" id="button_bg" transform="matrix(0.4211,0,0,0.75,0,0)" width="188"/>
  <atv:overwrite height="39.999" id="outer_frame" transform="matrix(0.4211,0,0,0.75,0,0)" width="190"/>
 </svg>
 <text atv:refpx="522.7" atv:refpy="36" fill="$Color$" font-family="Arial" font-size="24" id="Title_Text" x="505.5" y="40.5">Add to:</text>
 <svg atv:refpx="522.499" atv:refpy="133.997" height="60" id="Input_MultiText" transform="matrix(1.6228,0,0,1.2667,0,0)" width="570" x="36.973" xlink:href="SYSTEM.LIBRARY.PROJECT.OBJECTDISPLAYS.atvise_Advanced_Objects_Complementary_Elements.Multiple_In_Text_Efficient_Complementary_Element" y="75.787">
  <atv:argument name="Name" value="Global_List_Input"/>
  <atv:argument name="Global_List" prefix="Global_List"/>
  <atv:argument name="Label_Font_Color" prefix="Color"/>
  <atv:argument name="Font_Size" value="18"/>
  <atv:argument name="Border_Thickness" value="5"/>
  <atv:argument name="Border_Color" value="#e5e5e5"/>
  <atv:argument name="Label_Font_Size" value="24"/>
  <atv:argument name="Input_gap" value="5"/>
 </svg>
 <line atv:refpx="492.5" atv:refpy="65.5" id="id_3" stroke="$Color$" stroke-width="2" x1="0" x2="985" y1="65" y2="65"/>
 <script atv:desc="" atv:name="" type="text/ecmascript"><![CDATA[//---------------Initialize Variables---------//

//Internal

//Table Variables
var self;
var tableData = [];
var Table_Data=[];
var Ready_Data=[];
var Ind_Mant=0; //Variable for the finished maintenance
var item; //Variable for current maintenance info
var Table_Id;

//Maintenance
var Mant_ElementsR;
var Modify_Index=0;
var Table_Initialized=false;
var tableController;
var Action="Add";
var New_Values;
var New_Value;
var Global_Trigger_Value;
var Keys=["ID"]; 
var Columns_ConfigI=[{   id: "ID", name: "ID", field: "ID", sortable: false, filter: false, visible: true, width:10}];
console.log("Columns_Config");
console.log(Columns_ConfigI);

//External
var Global_List_Method=webMI.query["Global_List_Method"];
var Global_List_Address;
var Global_List_AddressR;
var Global_List;
var Global_Trigger=webMI.query["Global_Trigger"];
var Color=webMI.query["Color"];

//Confirmation Window Variables
var Action_Trigger_Name="Change_Global_Maintenance";
var Confirmation_Text;

//---------------Initial Conditions---------//
webMI.addOnload(function() {

	 //Define Global List 
	 if (Global_List_Method=="List"){  //Based on a List
		Global_List_Address=webMI.query["Global_List_Address"];
		Global_List=webMI.query["Global_List"];
		New_Values=Global_List[0];
		Mant_ElementsR=webMI.query["Mant_Elements"];
		//Columns_ConfigI.push({id: "ID", name: "ID", field: "ID", sortable: false, filter: false, visible: true, width:5});
	    for (const key in Global_List[0]) {
			Keys.push(key);
			Columns_ConfigI.push({id: String(key) , name: String(key), field: String(key), sortable: false, filter: false, visible: true, width:200})
		}
			 
		updateTitleText();
	 }
	 
	 
	  //Initialize Add as default 
	  webMI.trigger.fire("setSelectedItem_Maintenance_Modifier", {value:{value:0, text:Action}});

	 
	 
	  (async () => {
		 await waitForCondition();
			if (Global_List_Method=="List"){  //Based on a List				
				webMI.trigger.fire("update_mant_table", 0); //Update table				
			}
		})();


});



//---------------Trigger Section--------------//

//Monitor Global Maintenance Element
webMI.trigger.connect(Global_Trigger, function (e) {

	if(Global_List_Method=="Trigger"){
		Global_Trigger_Value=e;
		//Find the address of the global list
		Global_List_AddressR=e.value.Elements[0]+".Parameters.Mant_Address";
		Mant_ElementsR=Global_Trigger_Value.value.Elements[0]+".Parameters.Mant_Elements";
		//Read List Address
		webMI.data.read(Global_List_AddressR, function(e) {
			Global_List_Address=e.value;
			updateTitleText();
			//Read List
			webMI.data.read(Global_List_Address, function(f) {
				if (f.value!=undefined){
					var raw_List=f.value;			  
					Global_List=Process_read_List(raw_List);
			    }
			    (async () => {
					await waitForCondition();
					if (tableController!=undefined){
						//Update Table
						webMI.trigger.fire("update_mant_table", 0); //Update chart	
					}
				})();
			});
			
		});
	}
	
});


//Monitor Action Combobox 
webMI.trigger.connect("com.atvise.combobox_Maintenance_Modifier", function (e) {
	Action=e.value.text;	
	updateTitleText();
	console.log("Action: "+Action);	
});

//Monitor New Maintenance Input 
webMI.trigger.connect("read_value_Global_List_Input", function(e) {
	New_Values=e.value;	
});

//Excecute Action
webMI.addEvent("Excecute", "click", function(e) {

	if(Global_List_Address!=undefined){
		switch (Action) {
		  case "Add": //Add
			New_Value=Ready_Data.length+1;

			Confirmation_Text=Action+": <br> <br>"+" <span style='color: "+ Color +";text-decoration: underline;'>"+JSON.stringify(New_Values)+"</span>" +"<br> <br>to "+" <span style='color: "+ Color +";text-decoration: underline;'>"+(Global_List_Address.split(".")).pop()+"</span>";
			break;		
		  case "Modify": //Modify
			New_Value=Modify_Index+1;
			Confirmation_Text=Action+":<br><br>"+" <span style='color: "+ Color +";text-decoration: underline;'>"+JSON.stringify(Ready_Data[Modify_Index])+"</span> " +"<br><br> into"+" <span style='color: "+ Color +";text-decoration: underline;'>"+JSON.stringify(New_Values)+"</span>" +" <br> <br>from "+" <span style='color: "+ Color +";text-decoration: underline;'>"+(Global_List_Address.split(".")).pop()+"</span>";
			break;  
		  case "Remove": //Remove
			New_Value=0;
			Confirmation_Text=Action+": <br> <br>"+" <span style='color: "+ Color +";text-decoration: underline;'>"+JSON.stringify(Ready_Data[Modify_Index])+"</span>" +"<br> <br>from "+" <span style='color: "+ Color +";text-decoration: underline;'>"+(Global_List_Address.split(".")).pop()+"</span>";
			break;  
		}
		
		var Confirmation_Parameters={Action_Trigger_Name:Action_Trigger_Name,Confirmation_Text:Confirmation_Text};
		webMI.display.openWindow({display:"SYSTEM.LIBRARY.PROJECT.OBJECTDISPLAYS.atvise_Advanced_Objects_Complementary_Elements.Action_Confirmation_Window",extern:false,height:300,menubar:false,modal:false,movable:false,resizable:false,scrollbars:false,status:false,title:"Confirm Maintenance Change",toolbar:false,width:500,query:Confirmation_Parameters});
	
	}	
	
});


//Monitor change agreement
webMI.trigger.connect(Action_Trigger_Name, function(e) {
	var text=e.value;	
	
	//Excecute action
	modifyElement(Global_List_Address,Action,Modify_Index,New_Values);
});

//---------------Table Section--------------//
(async () => {
	await waitForCondition2();
	webMI.table.loadResources(function () {
	
		// Create the configuration //
		var config = [];
	
		// Configuration of the columns to be displayed //		
		config["columns"] = Columns_ConfigI;					
		
		
		// Configuration of the runtime behavior //
		config["mode"] = "live";
		
		// Configuration selection of data //
		config["onClickCallback"] = function(e, info){   
				
			item = info.item;     
			Modify_Index = info.rowIndex;
			Global_Id=item["ID Global"];
			Table_Id = item.id;
			
			if(Action=="Modify"){ //Only if it is in Modifying mode
				New_Values=Ready_Data[Modify_Index];
				webMI.trigger.fire("write_value_Global_List_Input", New_Values);
			}                
		}
		
		// Configuration of the data query //
		config["dataRequestFunction"] =
			function customDataRequest(continuation) {
				self = this;
				tableController = webMI.table.request("Mant_Global_List_Mod", "controller");
						
				webMI.trigger.connect("update_mant_table", function (h) {
				
					Table_Initialized=true;
					
					//------------Bring data from historian-----------//			
					
					//Filter Config
					Table_Data=[];
					Ready_Data=[];
	
					
					//Extract Data from Global_List				
					for (const i in Global_List) {
						if (Global_List.hasOwnProperty(i)) {
							Table_Data.push(Global_List[i]);
						}
					}				
					//Prepare Ready data									
					for (var i=0; i<Table_Data.length; i++){
						var ObjectI={}
						for (var j=0; j<Keys.length; j++){	
							if (Keys[j]=="ID"){
								ObjectI[String(Keys[j])]=i;
							}
							else{
								ObjectI[Keys[j]]=Global_List[i][Keys[j]]; 
							}
						}
	
						Ready_Data.push(ObjectI);				
					}					
					var data = {};
					data.result= Ready_Data;
					tableData.push(data);
					tableController.clearData(); //Clear Data
					self.addData(data);				
				});					
			};
			
	
		// Registration of the configuration //
		webMI.table.register("Mant_Global_List_Mod", "config",  config);
		webMI.table.setReady("Mant_Global_List_Mod", "config");
	});
})(); 



//---------------Functions Section--------------//

// Function to modify the Global List
function modifyElement(Global_List_Address,Action,Modify_Index,New_Value) {
	console.log("New_Value");
	console.log(New_Value);
	//Call Modification Script
    webMI.data.call("Global_List_Modifier_webMI_Method_Script", {"Global_List":Global_List_Address , "Action": Action, "Modify_Index":Modify_Index, "New_Value":New_Value}, function(e) {
		//Update Table
		if (tableController!=undefined){
			//Read new Global List
			webMI.data.read(Global_List_Address, function(e) {
			console.log("raw_List");
			console.log(raw_List);
			  var raw_List=e.value;			  
			  Global_List=Process_read_List(raw_List);			 
				
			  if (Global_List_Method=="List"){ 		
				 //Update Table and Combobox
				 webMI.trigger.fire("update_mant_table", 0); //Update chart
			  }
			  else if (Global_List_Method=="Trigger"){ 
				  //Update Node
				  webMI.data.write(Mant_ElementsR,JSON.stringify(Global_List));	
				  webMI.trigger.fire("Global_Object_Current_Addres", {Text:Global_Trigger_Value.value.Text, Elements:Global_Trigger_Value.value.Elements});
			  }
			});		
			
		}
	});
}

//Wait for data to be ready

function waitForCondition() {
  return new Promise((resolve) => {
    const interval = setInterval(() => {
	var condition=(tableController!=undefined&& Global_List!=undefined&& Columns_ConfigI.length>1);
      if (condition) {
        clearInterval(interval);
        resolve(true);
      }
    }, 100);
  });
}
function waitForCondition2() {
  return new Promise((resolve) => {
    const interval = setInterval(() => {
	var condition=(Global_List!=undefined&& Columns_ConfigI.length>1);
      if (condition) {
        clearInterval(interval);
        resolve(true);
      }
    }, 100);
  });
}


//Process Global List after read
function Process_read_List(raw_List){
	raw_List = raw_List.map((x, i) => JSON.parse('{' + x + '}')[i]);
			  
	  var Global_ListI={};
	  for (var i=0; i<raw_List.length; i++){
		Global_ListI[i]=raw_List[i];
	  }
	  
	  return Global_ListI;
}


//Update Title Text
function updateTitleText(){
	if(Global_List_Address!=undefined){
		var New_Text;
		switch (Action) {
			  case "Add": //Add
				New_Text="Adding to: "+(Global_List_Address.split(".")).pop();
				webMI.gfx.setText("Title_Text", New_Text);
				webMI.gfx.setVisible("Input_MultiText", true);
				break;		
			  case "Modify": //Modify
				New_Text="Modifying: "+(Global_List_Address.split(".")).pop();
				webMI.gfx.setText("Title_Text", New_Text);
				webMI.gfx.setVisible("Input_MultiText", true);
				break;  
			  case "Remove": //Remove
				New_Text="Removing from: "+(Global_List_Address.split(".")).pop();
				webMI.gfx.setText("Title_Text", New_Text);
				webMI.gfx.setVisible("Input_MultiText", false);
				break;  
		}
	}

}





]]></script>
</svg>
